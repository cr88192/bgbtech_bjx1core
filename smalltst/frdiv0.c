#include <stdio.h>
#include <stdlib.h>

#include <math.h>

int main()
{
	int divtab[256];
	double e0, e1, e2;
	double d0, d1, d2;
	int m1, m2, rf, p0, p1, p2, p3, p4;
	int i0, i1, i2, i3;
	int j0, j1, j2, j3, j4, j5, j6, j7;
	int i, j, k, n;
	
	e0=0;
	e1=0;
	e2=0;
	
	for(i=0; i<256; i++)
	{
		rf=0x800000/(1.0+(i/256.0));
		p0=(rf+127)>>8;
		p0=rf>>8;
		p0&=0xFFFC;
		divtab[i]=p0;
//		divtab[i]=rf;
	}
	
	for(i=0; i<64; i++)
	{
		for(j=0; j<4; j++)
		{
			printf("16'h%04X, ", divtab[i*4+j]);
//			printf("24'h%06X, ", divtab[i*4+j]);
		}
		printf("\n");
	}

#if 1
	n=16;
	for(i=0; i<(1<<n); i++)
	{
		m1=i<<(23-n);
//		j=0x800000/(0x800000+m1);
		rf=0x800000/(1.0+(i/((1<<n)*1.0)));

		m2=(m1>>12); m2=m2*m2;
//		m2=(((long long)m1)*m1)>>24;

		p0=0x800000-m1+
			(m1>>1)-(m1>>2)+(m1>>3);
//			-(m1>>4);
//			(m1>>5)-(m1>>6)+(m1>>7)-(m1>>8);
		p1=0x800000-(m1>>1);
//		p2=0x800000-(m1>>1)-(m1>>13);
//		p2=0x800000-(m1>>1)-(m1>>4)-(m1>>6)+(m2>>4);
		p2=0x800000-(m1>>1)-(m1>>4)-(m1>>6);

//		p2=0x800000-(m1>>1)-(m1>>2)+(m2>>1);
//		p2=0x800000-m1+m2;
		p2=0x800000-(m1>>1)-(m1>>2)-(m1>>3)+(m2>>1)+(m2>>2);

//		p2=0x800000-(m1>>2)-(m1>>3)-(m1>>3)-(m1>>5)-(m1>>5);
		
//		p1=divtab[(m1>>(23-8))&255]<<8;
//		p1+=divtab[(m1>>(23-16))&255]>>3;

//		i0=(m1>>(23-8))&255;
//		i0=((m1+32767)>>(23-8))&255;
//		i0=((m1+32767)>>(23-8));
		i0=(m1>>(23-8));
//		i0=((m1+16383)>>(23-8));
		if(i0<0)i0=0;
		if(i0>255)i0=255;
		i1=i0-1;
		if(i1<0)i1=0;
		if(i1>255)i1=255;
//		j0=divtab[i0]-divtab[i1];
		j4=divtab[i0];
		j5=divtab[i1];
		j0=j5-j4;
		p1=divtab[i0]<<8;
//		p1=divtab[i0];

		j6=j4<<8;
		j7=j5<<8;
		
//		printf("   %04X\n", j0);
		
		i2=(m1>>(23-16))&255;
		j2=divtab[i2];
		
//		p1+=divtab[i2]*(j0>>7);
//		j1=((m1&32767)*j0)>>10;

//		j1=((m1&32767)*j4)>>15;
//		j1=((32767-(m1&32767))*j4)>>16;
//		j1=((16383-(m1&32767))*j4)>>16;
//		j1=((32767-(m1&65535))*j4)>>16;
//		j1=((16383-(m1&32767))*j4)>>24;
//		j1=(16383-(m1&32767))>>8;

		j3=(m1&32767);
//		j3=j3-(j3>>7);
//		j3=j3+(j3>>7);
		j3=j3-(j3>>5)+(j3>>6);

//		j3=j3+(j3>>5);

//		j3=j3-(j3>>6);
//		j3=j3-(j3>>5);
		j1=j3>>1;
//		j1=(j3*j4)>>16;
//		if(p1<0x500000)

		if((p1&0xF00000)==0x800000)
			j1=j1<<1;
		if((p1&0xF00000)==0x700000)
			j1=j1<<1;
//		if((p1&0xB00000)==0x200000)
//			j1=j1<<1;

//		if((p1&0xB00000)==0x100000)
//			j1=j1>>1;

		if((p1&0xF00000)==0x400000)
			j1=j1>>1;

//		j1=((m1&32767)*j4)>>16;

//		printf("   %08X\n", j1);
//		printf("   %08X\n", j2);
//		p1+=j1;

//		printf("   %08X %08X %04X\n", p1, p1-rf, m1&32767);
		p1-=j1;
//		p1-=(m1&32767)>>1;
		
//		if(j0<0)break;	
//		if((p1<j6) || (p1>j7))
//			break;

#if 1
		switch((rf>>20)&15)
		{
//		case 8: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3); break;
//		case 7: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3); break;
//		case 6: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>5); break;
//		case 5: p0=0x800000-(m1>>1)-(m1>>3)-(m1>>6); break;
//		case 4: p0=0x800000-(m1>>1)-(m1>>4)+(m1>>6); break;

		case 8: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3)-(m2>>1)+(m2>>4); break;
		case 7: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3)-(m2>>1)+(m2>>4); break;
		case 6: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3)+(m2>>1)+(m2>>2); break;
		case 5: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3)+(m2>>1)+(m2>>2); break;
		case 4: p0=0x800000-(m1>>1)-(m1>>2)-(m1>>3)+(m2>>1)+(m2>>2); break;
		}
#endif
		
		d0=(p0-rf)/8388608.0;
		d1=(p1-rf)/8388608.0;
		d2=(p2-rf)/8388608.0;
		
//		e0+=(p0-rf)*(p0-rf);
//		e1+=(p1-rf)*(p1-rf);
//		e2+=(p2-rf)*(p2-rf);

		e0+=d0*d0;
		e1+=d1*d1;
		e2+=d2*d2;
		
//		printf("%4d m=%6X ref=%6X p0=%6X p1=%6X p2=%6X\n",
//			i, m1, rf, p0, p1, p2);
	}
	
	printf("e0=%f e1=%f e2=%f\n",
		sqrt(e0/(1<<n)),
		sqrt(e1/(1<<n)),
		sqrt(e2/(1<<n)));
#endif
}
